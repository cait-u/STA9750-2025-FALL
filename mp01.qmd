---
title: "STA 9750 — Mini-Project 01"
author: "Caitlin Uang"
date: "`r Sys.Date()`"
format:
  html:
    theme: default
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
editor: visual
execute:
  warning: false
  message: false
  echo: true
---

```{r}
if(!dir.exists(file.path("data", "mp01"))){
    dir.create(file.path("data", "mp01"), showWarnings=FALSE, recursive=TRUE)
}

GLOBAL_TOP_10_FILENAME <- file.path("data", "mp01", "global_top10_alltime.csv")

if(!file.exists(GLOBAL_TOP_10_FILENAME)){
    download.file("https://www.netflix.com/tudum/top10/data/all-weeks-global.tsv", 
                  destfile=GLOBAL_TOP_10_FILENAME)
}

COUNTRY_TOP_10_FILENAME <- file.path("data", "mp01", "country_top10_alltime.csv")

if(!file.exists(COUNTRY_TOP_10_FILENAME)){
    download.file("https://www.netflix.com/tudum/top10/data/all-weeks-countries.tsv", 
                  destfile=COUNTRY_TOP_10_FILENAME)
}
```

```{r}
if(!require("tidyverse")) install.packages("tidyverse")
library(readr)
library(dplyr)

GLOBAL_TOP_10 <- read_tsv(GLOBAL_TOP_10_FILENAME)
```

```{r}
str(GLOBAL_TOP_10)
```

```{r}
glimpse(GLOBAL_TOP_10)
```

```{r}
GLOBAL_TOP_10 <- GLOBAL_TOP_10 |>
    mutate(season_title = if_else(season_title == "N/A", NA, season_title))

glimpse(GLOBAL_TOP_10)
```

```{r}
COUNTRY_TOP_10 <- read_tsv(COUNTRY_TOP_10_FILENAME)

COUNTRY_TOP_10 <- COUNTRY_TOP_10 |>
    mutate(season_title = if_else(season_title == "N/A", NA, season_title))

glimpse(COUNTRY_TOP_10)

```

```{r}
library(DT)
GLOBAL_TOP_10 |> 
    head(n=20) |>
    datatable(options=list(searching=FALSE, info=FALSE))
```

```{r}
library(stringr)
format_titles <- function(df){
    colnames(df) <- str_replace_all(colnames(df), "_", " ") |> str_to_title()
    df
}

GLOBAL_TOP_10 |> 
    format_titles() |>
    head(n=20) |>
    datatable(options=list(searching=FALSE, info=FALSE)) |>
    formatRound(c('Weekly Hours Viewed', 'Weekly Views'))
```

```{r}
GLOBAL_TOP_10 |> 
    mutate(`runtime_(minutes)` = round(60 * runtime)) |>
    select(-season_title, 
           -runtime) |>
    format_titles() |>
    head(n=20) |>
    datatable(options=list(searching=FALSE, info=FALSE)) |>
    formatRound(c('Weekly Hours Viewed', 'Weekly Views'))
```

```{r}
library(dplyr)

#Question 1
countries_count <- COUNTRY_TOP_10 |>
  distinct(country_name) |>
  nrow()

#Question 2
non_english <- GLOBAL_TOP_10 |>
  mutate(Language = str_extract(category, "\\((.*)\\)"),
         Language = str_replace_all(Language, "[()]", "")) |>
  filter(str_detect(category, "Film"), Language != "English") |>
  group_by(show_title) |>
  summarise(total_weeks = sum(cumulative_weeks_in_top_10, na.rm = TRUE)) |>
  arrange(desc(total_weeks)) |>
  slice(1)

#Question 3
longest_film <- GLOBAL_TOP_10 |>
  filter(str_detect(category, "Film")) |>
  arrange(desc(runtime)) |>
  slice(1)

#Questions 4
library(scales)
total_hours <- GLOBAL_TOP_10 |>
  group_by(category, show_title) |>
  summarise(total_hours = sum(weekly_hours_viewed, na.rm = TRUE), .groups = "drop") |>
  group_by(category) |>
  slice_max(total_hours, n = 1) |>
  ungroup() |>
  format_titles() |>
  mutate(`Total Hours` = comma(`Total Hours`))

#Question 5


```

## Exploratory Questions

1. How many different countries does Netflix operate in?

Netflix operates in `r countries_count` countries.

2. Which non-English-language film has spent the most cumulative weeks in the global top 10? How many weeks did it spend?

The non-English-language film that spent the longest time in the global top 10 is `r non_english$show_title` at `r non_english$total_weeks` weeks.

3. What is the longest film (English or non-English) to have ever appeared in the Netflix global Top 10? How long is it in minutes?

The longest film to have ever appeared in the global top 10 is `r longest_film$show_title` at `r longest_film$runtime` minutes.

4. For each of the four categories, what program has the most total hours of global viewership?

```{r}
total_hours |>
  DT::datatable(
    options = list(
      pageLength = 10,
      searching = TRUE,
      info = TRUE
    )
  )
```
5. Which TV show had the longest run in a country’s Top 10? How long was this run and in what country did it occur?

The longest running TV

